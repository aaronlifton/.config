local M = {}

local H = {}
H.is_executable = function(tool)
  if tool == "fallback" then return true end
  return vim.fn.executable(tool) == 1
end
H.get_config = function(config)
  return vim.tbl_deep_extend("force", MiniPick.config, vim.b.minipick_config or {}, config or {})
end
H.full_path = function(path)
  return (vim.fn.fnamemodify(path, ":p"):gsub("(.)/$", "%1"))
end
H.grep_get_command = function(pattern, extra_args)
  local res = {
    "rg",
    "--column",
    "--line-number",
    "--no-heading",
    "--field-match-separator",
    "\\x00",
    "--color=never",
  }
  if vim.islist(extra_args) then vim.list_extend(res, extra_args) end
  local case = vim.o.ignorecase and (vim.o.smartcase and "smart-case" or "ignore-case") or "case-sensitive"
  vim.list_extend(res, { "--" .. case, "--", pattern })
  return res
end

local function create_rg_live_picker(MiniPick, name, extra_args)
  return function(local_opts, opts)
    local_opts = vim.tbl_extend("force", { tool = nil }, local_opts or {})
    local tool = local_opts.tool or "rg"
    if tool == "fallback" or not H.is_executable(tool) then
      vim.notify("`" .. name .. "` picker requires ripgrep (rg) to be installed.", vim.log.levels.ERROR)
      return
    end

    local show = H.get_config().source.show
    local default_source = { name = name, show = show }
    opts = vim.tbl_deep_extend("force", { source = default_source }, opts or {})

    local cwd = H.full_path(opts.source.cwd or vim.fn.getcwd())
    local set_items_opts, spawn_opts = { do_match = false }, { cwd = cwd }
    local process
    local match = function(_, _, query)
      ---@diagnostic disable-next-line: undefined-field
      pcall(vim.loop.process_kill, process)

      if #query == 0 then return MiniPick.set_picker_items({}, set_items_opts) end

      local pattern = table.concat(query)
      if pattern == "" then return MiniPick.set_picker_items({}, set_items_opts) end

      local command = H.grep_get_command(pattern, extra_args)
      process = MiniPick.set_picker_items_from_cli(command, {
        set_items_opts = set_items_opts,
        spawn_opts = spawn_opts,
      })
    end

    opts = vim.tbl_deep_extend("force", opts or {}, { source = { items = {}, match = match } })
    return MiniPick.start(opts)
  end
end

M.setup = function(MiniPick)
  MiniPick.registry.rg_fixed = create_rg_live_picker(MiniPick, "Grep (--fixed-strings)", { "--fixed-strings" })
  MiniPick.registry.rg_pcre2 = create_rg_live_picker(MiniPick, "Grep (--pcre2)", { "--pcre2" })
end

return M
